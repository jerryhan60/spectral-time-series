================================================================================
EVALUATION PIPELINE AND PRECONDITIONING EXPLORATION - FINAL SUMMARY
================================================================================

Date: 2025-11-02
Thoroughness Level: VERY THOROUGH - Complete Architecture Analysis
Working Directory: /scratch/gpfs/EHAZAN/jh1161

================================================================================
EXPLORATION RESULTS
================================================================================

1. EVALUATION SCRIPTS/CODE IDENTIFIED
================================================================================

Primary Files:
- /scratch/gpfs/EHAZAN/jh1161/uni2ts/cli/eval.py (Entry point)
- /scratch/gpfs/EHAZAN/jh1161/uni2ts/src/uni2ts/eval_util/evaluation.py (Core evaluation)
- /scratch/gpfs/EHAZAN/jh1161/uni2ts/src/uni2ts/eval_util/data.py (Data loading)

Configuration Files:
- /scratch/gpfs/EHAZAN/jh1161/uni2ts/cli/conf/eval/default.yaml
- /scratch/gpfs/EHAZAN/jh1161/uni2ts/cli/conf/eval/model/moirai_lightning_ckpt_precond.yaml
- /scratch/gpfs/EHAZAN/jh1161/uni2ts/cli/conf/eval/data/monash.yaml

Key Functions:
- evaluate_model() at line 228
- evaluate_forecasts() at line 176  
- _get_data_batch() at line 57
- create_predictor() at line 123 (MoiraiForecast)
- get_default_transform() at line 941 (MoiraiForecast)


2. PRECONDITIONING IMPLEMENTATION ANALYSIS
================================================================================

File: /scratch/gpfs/EHAZAN/jh1161/uni2ts/src/uni2ts/transform/precondition.py

PolynomialPrecondition Class (Line 24-248):
- Status: FULLY IMPLEMENTED AND WELL-TESTED
- Purpose: Apply polynomial preconditioning to time series
- Formula: ỹₜ = yₜ - ∑ᵢ₌₁ⁿ cᵢ · yₜ₋ᵢ
- Supports: Chebyshev and Legendre polynomials
- Parameters: polynomial_type, degree (5-10), target_field, enabled
- Key Method: _apply_convolution() - Vectorized numpy implementation
- Storage: Stores coefficients in data entry for reversal

ReversePrecondition Class (Line 250-376):
- Status: FULLY IMPLEMENTED AND WELL-TESTED  
- Purpose: Reverse polynomial preconditioning
- Formula: yₜ = ỹₜ + ∑ᵢ₌₁ⁿ cᵢ · yₜ₋ᵢ
- Handles: 1D, 2D, 3D arrays (including batch predictions)
- Key Method: _reverse_convolution() - Iterative implementation
- Requirement: Needs precondition_coeffs in data entry


3. MOIRAI FORECAST CLASS STRUCTURE
================================================================================

File: /scratch/gpfs/EHAZAN/jh1161/uni2ts/src/uni2ts/model/moirai/forecast.py

MoiraiForecast Class (Line 72-979):
- Status: WORKS BUT LACKS PRECONDITIONING SUPPORT
- Key Methods:
  - create_predictor() (Line 123): Creates PyTorchPredictor
  - get_default_transform() (Line 941): Builds input transformation chain
  - forward() (Line 238): Forward pass through model
  - _convert() (Line 506): Data conversion for model
  - _format_preds() (Line 925): Format output predictions

Critical Issue:
- get_default_transform() does NOT include PolynomialPrecondition
- create_predictor() doesn't pass preconditioning params
- PyTorchPredictor created without output_transform for reversal

Related Class: MoiraiForecastPrecond (forecast_precond.py)
- Status: INCOMPLETE/ATTEMPTED FIX
- Constructor includes preconditioning parameters
- Has _apply_preconditioning_numpy() and _reverse_preconditioning_numpy()
- CRITICAL ISSUE: forward() method bypasses preconditioning with comment about "shape mismatches"


4. DATA PIPELINE AND TRANSFORMATIONS
================================================================================

Data Flow During Evaluation:

Raw Test Data
    ↓
get_gluonts_test_dataset() or similar
    ↓
Load data WITHOUT preconditioning transforms
    ↓
PyTorchPredictor.create_predictor() builds transform chain
    ├─ AsNumpyArray (convert to numpy)
    ├─ ExpandDimArray (add dimension if needed)
    ├─ AddObservedValuesIndicator (add mask)
    ├─ [NO PolynomialPrecondition HERE - THIS IS THE PROBLEM!]
    └─ TFTInstanceSplitter (split for inference)
    ↓
model.forward() generates predictions
    ↓
evaluate_model() computes metrics
    ├─ No reversal of preconditioning
    └─ Metrics computed in wrong space if model was trained with preconditioning

Transformation Chain Class:
- File: /scratch/gpfs/EHAZAN/jh1161/uni2ts/src/uni2ts/transform/_base.py
- Chain class enables sequential composition with __add__ operator
- Supports: Identity, chain operations


5. TRAINING VS EVALUATION MISMATCH
================================================================================

TRAINING (from pretrain.py, Line 387-392):
- PolynomialPrecondition IS applied
- Data flows: Original → Preconditioned → Standardized → Model
- Model learns on preconditioned data space

EVALUATION (from forecast.py, Line 941-978):
- PolynomialPrecondition NOT applied
- Data flows: Original → Standardized → Model
- Model predicts in original space (but was trained in preconditioned space!)

RESULT: UNFAIR COMPARISON
- Model outputs are in different space than training
- Metrics are computed in wrong space
- Preconditioning benefits not properly captured


6. EVALUATION CONFIGURATION FILES
================================================================================

default.yaml:
- Default batch_size: 512
- min_batch_size: 1
- Metrics: MSE, MAE, MASE, MAPE, SMAPE, MSIS, RMSE, NRMSE, ND, etc.
- No preconditioning parameters

moirai_lightning_ckpt_precond.yaml:
- PARAMETERS EXIST but NOT USED:
  - reverse_preconditioning: true
  - precondition_type: chebyshev
  - precondition_degree: 5
- These parameters are in config but MoiraiForecast doesn't handle them

monash.yaml:
- Uses get_gluonts_test_dataset
- No preconditioning in data loading


7. KEY FINDINGS AND ISSUES
================================================================================

ISSUE 1: Input Transform Missing Preconditioning
- Location: MoiraiForecast.get_default_transform() (Line 941)
- Problem: PolynomialPrecondition not included in transform chain
- Impact: Models trained with preconditioning evaluated without it

ISSUE 2: No Output Transform for Reversal
- Location: PyTorchPredictor creation in create_predictor() (Line 144-151)
- Problem: No output_transform parameter to apply ReversePrecondition
- Impact: Predictions in preconditioned space never reversed to original

ISSUE 3: MoiraiForecastPrecond Forward Method Incomplete
- Location: forecast_precond.py, Line 204-246
- Problem: forward() method bypasses preconditioning
- Status: Code exists but commented as not working
- Reason Given: "shape mismatches" and standardization conflicts

ISSUE 4: Preconditioning Parameters Not Passed Through Pipeline
- Problem: Config has parameters but they're not read/used by model
- Impact: No way to enable preconditioning during evaluation

ISSUE 5: GluonTS PyTorchPredictor Architecture Limitation
- Problem: PyTorchPredictor doesn't support output_transform
- Impact: Can't apply ReversePrecondition after predictions


8. WHAT NEEDS TO BE FIXED
================================================================================

Fix Level 1 (Immediate):
- Add preconditioning parameters to MoiraiForecast.__init__()
- Modify get_default_transform() to include PolynomialPrecondition
- Pass preconditioning params from config to model

Fix Level 2 (Core):
- Create wrapper or custom predictor class with output_transform support
- Apply ReversePrecondition to predictions before metric computation
- Update evaluate_model() to handle preconditioning reversal

Fix Level 3 (Proper):
- Debug and fix MoiraiForecastPrecond.forward() method
- Resolve "shape mismatch" issues mentioned in code
- Test with standardization to ensure compatibility
- Make MoiraiForecastPrecond the default for preconditioned models

Fix Level 4 (Configuration):
- Update evaluation config to properly handle preconditioning
- Create separate eval configs for preconditioned vs standard models
- Ensure preconditioning parameters always passed through


9. FILES AFFECTED BY NEEDED CHANGES
================================================================================

PRIMARY (Must Change):
1. /scratch/gpfs/EHAZAN/jh1161/uni2ts/src/uni2ts/model/moirai/forecast.py
   - Modify __init__ to accept preconditioning params
   - Modify get_default_transform()
   - Modify create_predictor()

2. /scratch/gpfs/EHAZAN/jh1161/uni2ts/src/uni2ts/eval_util/evaluation.py
   - Modify evaluate_model() to apply reversal

3. /scratch/gpfs/EHAZAN/jh1161/uni2ts/cli/eval.py
   - Pass preconditioning config to model

SECONDARY (Should Consider):
4. /scratch/gpfs/EHAZAN/jh1161/uni2ts/src/uni2ts/model/moirai/forecast_precond.py
   - Debug and complete implementation
   - Fix forward() method

5. Configuration files:
   - /scratch/gpfs/EHAZAN/jh1161/uni2ts/cli/conf/eval/model/moirai_lightning_ckpt_precond.yaml
   - /scratch/gpfs/EHAZAN/jh1161/uni2ts/cli/conf/eval/default.yaml

REFERENCE (For Understanding):
6. /scratch/gpfs/EHAZAN/jh1161/uni2ts/src/uni2ts/model/moirai/pretrain.py
   - Shows correct preconditioning application during training


10. DELIVERABLES GENERATED
================================================================================

Three comprehensive documents created:

1. EVALUATION_PRECONDITIONING_ANALYSIS.md (Main Report)
   - 500+ lines of detailed analysis
   - Complete architecture overview
   - Problem summary and recommended fixes
   - Key files and functions reference
   - Data structures and transformations

2. PRECONDITIONING_QUICK_REFERENCE.md (Quick Lookup)
   - 300+ lines of quick reference
   - File locations at a glance
   - Key classes and methods
   - Training vs evaluation comparison
   - Debugging checklist
   - Quick commands

3. EXPLORATION_SUMMARY.txt (This File)
   - Executive summary of findings
   - File locations and issue descriptions
   - What needs to be fixed


================================================================================
CONCLUSION
================================================================================

The evaluation pipeline has a COMPLETE DISCONNECT from preconditioning:

TRAINING: Preconditions data before feeding to model
EVALUATION: Doesn't precondition data but model was trained on preconditioned data

Root Cause: MoiraiForecast.get_default_transform() doesn't include 
PolynomialPrecondition, even when model was trained with it.

Status: 
- Preconditioning transforms are well-implemented
- Training pipeline correctly applies preconditioning
- Issue is purely architectural - components not integrated
- Fix is feasible but requires changes across 3 layers

Impact:
- Models trained WITH preconditioning evaluated WITHOUT it
- Metrics computed in wrong space
- Preconditioning benefits not properly captured
- Unfair comparison between preconditioned and standard models

================================================================================
